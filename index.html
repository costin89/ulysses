<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoLoc</title>
</head>

<body>
<center>
<br><br>
<button onclick="fetchData()">GeoLoc</button>
<br><br>
<table border="1">
    <thead>
        <tr>
            <th>#</th>
            <th>Breitengrad</th>
            <th>Längengrad</th>
            <th>Absolute Kompassausrichtung</th>
        </tr>
    </thead>
    <tbody id="dataOutput">
    </tbody>
</table>
<br><br>
<button onclick="insertData()">+ In Tabelle einfügen</button>
</center>
<script>
    let rowCount = 0;
    let lastLatitude = null;
    let lastLongitude = null;
    let lastAlpha = null;

    async function fetchData() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                lastLatitude = position.coords.latitude;
                lastLongitude = position.coords.longitude;
                requestPermission(); // Aufruf der Permission Funktion für die DeviceOrientation
            }, error => {
                alert('Fehler beim Abrufen der Geolokalisierungsdaten: ' + error.message);
            });
        } else {
            alert('Geolocation wird von diesem Browser nicht unterstützt.');
        }
    }


    function insertData() {
        if (lastLatitude !== null && lastLongitude !== null && lastAlpha !== null) {
            rowCount++;
            let row = document.createElement('tr');
            row.innerHTML = `<td>${rowCount}</td><td>${lastLatitude.toFixed(6)}</td><td>${lastLongitude.toFixed(6)}</td><td>${lastAlpha ? lastAlpha.toFixed(2) + '°' : 'Nicht unterstützt'}</td>`;
            document.getElementById('dataOutput').appendChild(row);
        } else {
            alert('Bitte zuerst GeoLoc Daten abrufen.');
        }
    }

    function adjustCompass(compassHeading, windowOrientation) {
      var adjustedCompassHeading = compassHeading;
      if (windowOrientation === 90) {
        adjustedCompassHeading = (compassHeading - 270 + 360) % 360;
      } else if (windowOrientation === -90) {
        adjustedCompassHeading = (compassHeading + 270) % 360;
      }
      return adjustedCompassHeading;
    }

    async function requestPermission() {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          init();
        } else {
          alert('Berechtigung nicht erteilt');
        }
      } else {
        alert("Diese Anwendung muss auf den Kompass Ihres Geräts zugreifen. Bitte erlauben Sie den Zugriff, wenn Sie dazu aufgefordert werden.");
        init();
      }
    }

    function init() {
      if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', handleOrientation, true);
      } else {
        document.getElementById("status").innerHTML = "Ihr Browser unterstützt keine Device Orientation Events.";
      }
    }

    function handleOrientation(event) {
      var compassHeading = event.webkitCompassHeading || 360 - event.alpha;
      var windowOrientation = window.orientation || 0;
      lastAlpha = adjustCompass(compassHeading, windowOrientation);
    }

</script>

</body>

</html>
