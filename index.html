<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoLoc</title>
</head>
<body>
<br><br>
<center>
<button onclick="fetchData()">GeoLoc</button>
<br><br>
<table>
    <thead>
        <tr>
            <th>#</th>
            <th>Breitengrad</th>
            <th>Längengrad</th>
            <th>Kompass</th>
        </tr>
    </thead>
    <tbody id="dataOutput">
    </tbody>
</table>
<br><br>
<button onclick="insertData()">+ In Tabelle einfügen</button>
</center>
<script>
    let rowCount = 0;
    let lastLatitude = null;
    let lastLongitude = null;
    let lastAlpha = null;

    function fetchData() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                lastLatitude = position.coords.latitude;
                lastLongitude = position.coords.longitude;

                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(permissionState => {
                        if (permissionState === 'granted') {
                            attachOrientationListener();
                        }
                    }).catch(console.error);
                } else {
                    attachOrientationListener();
                }
            });
        } else {
            alert('Geolocation wird von diesem Browser nicht unterstützt.');
        }
    }

    function attachOrientationListener() {
        window.addEventListener('deviceorientation', function(event) {
            if (event.absolute) {
                let alpha = event.alpha;
                if (typeof event.webkitCompassHeading !== "undefined") {
                    alpha = event.webkitCompassHeading; // für Safari
                }
                lastAlpha = alpha;
            } else {
                alert("Absoluter Kompasswert nicht verfügbar.");
            }
        }, { once: true });
    }

    function insertData() {
        if (lastLatitude !== null && lastLongitude !== null) {
            rowCount++;
            let row = document.createElement('tr');
            row.innerHTML = `<td>${rowCount}</td><td>${lastLatitude.toFixed(6)}</td><td>${lastLongitude.toFixed(6)}</td><td>${lastAlpha ? lastAlpha.toFixed(2) + '°' : 'Nicht unterstützt'}</td>`;
            document.getElementById('dataOutput').appendChild(row);
        } else {
            alert('Bitte zuerst GeoLoc Daten abrufen.');
        }
    }
</script>
</body>
</html>
